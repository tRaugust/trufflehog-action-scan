# This is a basic workflow to help you get started with Actions

name: perform self-test of action

# Controls when the action will run. Triggers the workflow on push or pull request
# events but only for the master branch
on:
  push:
    branches: [ master, test_actions, upgrade_to_trufflehog3 ]


## A workflow . run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "build"
  scan-code:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest

    ## Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      - uses: actions/checkout@master
      - name: Self test
        id: selftest
        uses: ./
        continue-on-error: true
#      - name: Uploading Logfile
#        uses: actions/upload-artifact@v1
#        if: failure()
#        with:
#          name: trufflehog-logfile.log
#          path: TRufflehog.log
      - name: write comment on push
        if: ${{ steps.selftest.outputs.numWarnings > 0 }}
        uses: peter-evans/commit-comment@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          body: |
            Trufflehog scan found ${{steps.selftest.outputs.numWarnings}} suspicious lines in code.
            These could contain secrets that were committed accidentally.
            Please review the following files :
            ```
            ${{steps.selftest.outputs.warningsText}}
            ```
            <details>
            <summary>Review the full trufflehog scan log:</summary>

            ```
            ${{steps.selftest.outputs.warningsJSON}}
            ```
            </details>

      - name: Dump steps context
        if: failure()
        env:
          STEPS_CONTEXT: ${{ toJson(steps) }}
        run: echo "$STEPS_CONTEXT"
      - name: Dump GitHub context
        if: failure()
        env:
          GITHUB_CONTEXT: ${{ toJson(github) }}
        run: echo "$GITHUB_CONTEXT"
      - name: Dump job context
        if: failure()
        env:
          JOB_CONTEXT: ${{ toJson(job) }}
        run: echo "$JOB_CONTEXT"

