name: perform self-test of action
on:
  push:
    branches: [ master, test_actions, upgrade_to_trufflehog3 ]
jobs:
  scan-code:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@master
      - name: Self test
        id: selftest
        uses: ./
        ##error is expected as the test scan on this repo will find the patterns in the config file
        continue-on-error: true
#      - name: Uploading Logfile
#        uses: actions/upload-artifact@v1
#        if: failure()
#        with:
#          name: trufflehog-logfile.log
#          path: TRufflehog.log
      - name: write comment on push
        if: ${{ steps.selftest.outputs.numWarnings > 0 }}
        uses: peter-evans/commit-comment@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          body: |
            Trufflehog scan found ${{steps.selftest.outputs.numWarnings}} suspicious lines in code ( **16 ARE EXPECTED in this self-test** ).
            These could contain secrets that were committed accidentally.
            Please review the following files :
            ```
            ${{steps.selftest.outputs.warningsText}}
            ```
            <details>
            <summary>Review the full trufflehog scan log:</summary>

            ```
            ${{steps.selftest.outputs.warningsJSON}}
            ```
            </details>
      - name: fail if amount of matches is unexpected (i.e. != 16)
        if: ${{ steps.selftest.outputs.numWarnings != 16  }}
        run: exit 1
### This is for debugging the self-test and is only executed if above steps fail
      - name: Dump steps context
        if: failure()
        env:
          STEPS_CONTEXT: ${{ toJson(steps) }}
        run: echo "$STEPS_CONTEXT"
      - name: Dump GitHub context
        if: failure()
        env:
          GITHUB_CONTEXT: ${{ toJson(github) }}
        run: echo "$GITHUB_CONTEXT"
      - name: Dump job context
        if: failure()
        env:
          JOB_CONTEXT: ${{ toJson(job) }}
        run: echo "$JOB_CONTEXT"

